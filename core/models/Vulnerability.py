import hashlib
from django.db import models


class Vulnerability(models.Model):
    # 關聯資產 (保留外鍵，方便在 Dashboard 跳轉)
    ip_asset = models.ForeignKey(
        "core.IP",
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name="vulnerabilities",
    )
    subdomain_asset = models.ForeignKey(
        "core.Subdomain",
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name="vulnerabilities",
    )
    url_asset = models.ForeignKey(
        "core.URLResult",
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name="vulnerabilities",
    )

    # 核心信息
    tool_source = models.CharField(max_length=50, default="nuclei")
    template_id = models.CharField(max_length=255, db_index=True)  # 如: openssh-detect
    name = models.CharField(max_length=500)
    severity = models.CharField(max_length=20, db_index=True)  # info, low, medium, etc.

    # 位置信息 (JSON 裡的 matched-at)
    matched_at = models.TextField()  # 如: 45.33.32.156:22 或 http://scanme.nmap.org

    # 發現內容 (JSON 裡的 extracted-results)
    extracted_results = models.JSONField(
        null=True, blank=True
    )  # 存版本號或漏洞 Payload

    request_raw = models.TextField(null=True, blank=True)
    response_raw = models.TextField(null=True, blank=True)

    # 唯一性指紋 (防止重複寫入)
    # sha256(template_id + matched_at)
    fingerprint = models.CharField(max_length=64, unique=True, db_index=True)

    status = models.CharField(
        max_length=20, default="unverified"
    )  # unverified, confirmed, false_positive
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name = "Vulnerability"
        ordering = ["-created_at"]
